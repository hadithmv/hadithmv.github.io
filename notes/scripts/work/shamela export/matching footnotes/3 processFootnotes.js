const fs = require("fs");

// Read the JSON file
fs.readFile("addfootnotestothis.json", "utf8", (err, data) => {
  if (err) {
    console.error(err);
    return;
  }

  let jsonData = JSON.parse(data);

  // Read the footnotes file
  fs.readFile("footnotes.txt", "utf8", (err, footnotesData) => {
    if (err) {
      console.error(err);
      return;
    }

    // Make sure footnotes is initialized as an array even if match returns null
    let footnotes = footnotesData.match(/\[\d+\][^\[\]]+/g) || [];
    let globalUsedFootnotes = []; // To keep track of all used footnotes globally

    // Process the data
    for (let i = 0; i < jsonData.length; i++) {
      let entryFootnotes = [...footnotes]; // Reset footnotes for each entry

      // Filter out globally used footnotes
      entryFootnotes = entryFootnotes.filter(
        (fn) => !globalUsedFootnotes.includes(fn)
      );

      let matches = jsonData[i][0].match(/\[\d+\]/g);
      if (matches) {
        for (let j = 0; j < matches.length; j++) {
          let match = matches[j];
          let index = entryFootnotes.findIndex((fn) => fn.startsWith(match));
          if (index !== -1) {
            let footnoteNumber = match.substring(1, match.length - 1);
            let footnoteText = entryFootnotes[index].replace(match, "").trim();
            if (jsonData[i][1]) {
              jsonData[i][1] += "\n[" + footnoteNumber + "] " + footnoteText;
            } else {
              jsonData[i][1] = "[" + footnoteNumber + "] " + footnoteText;
            }
            globalUsedFootnotes.push(entryFootnotes[index]); // Mark footnote as used
            entryFootnotes.splice(index, 1); // Remove the used footnote from entry-specific list
          }
        }
      }
    }

    // Write the output JSON file
    fs.writeFile("output.json", JSON.stringify(jsonData, null, 2), (err) => {
      if (err) {
        console.error(err);
        return;
      }
      console.log("Output JSON file has been created successfully.");
    });
  });
});

//
/*

 started out same as dfk script, but continous footnote numbers made them repeat erronously 

...


this is my initial code below:

...

const fs = require("fs");

// Read the JSON file
fs.readFile("addfootnotestothis.json", "utf8", (err, data) => {
  if (err) {
    console.error(err);
    return;
  }

  let jsonData = JSON.parse(data);

  // Read the footnotes file
  fs.readFile("footnotes.txt", "utf8", (err, footnotesData) => {
    if (err) {
      console.error(err);
      return;
    }

    let footnotes = footnotesData.match(/\[\d+\][^\[\]]+/g);
    let globalUsedFootnotes = []; // To keep track of all used footnotes globally

    // Process the data
    for (let i = 0; i < jsonData.length; i++) {
      let entryFootnotes = [...footnotes]; // Reset footnotes for each entry

      // Filter out globally used footnotes
      entryFootnotes = entryFootnotes.filter(
        (fn) => !globalUsedFootnotes.includes(fn)
      );

      let matches = jsonData[i][0].match(/\[\d+\]/g);
      if (matches) {
        for (let j = 0; j < matches.length; j++) {
          let match = matches[j];
          let index = entryFootnotes.findIndex((fn) => fn.startsWith(match));
          if (index !== -1) {
            let footnoteNumber = match.substring(1, match.length - 1);
            let footnoteText = entryFootnotes[index].replace(match, "").trim();
            if (jsonData[i][1]) {
              jsonData[i][1] += "\n[" + footnoteNumber + "] " + footnoteText;
            } else {
              jsonData[i][1] = "[" + footnoteNumber + "] " + footnoteText;
            }
            globalUsedFootnotes.push(entryFootnotes[index]); // Mark footnote as used
            entryFootnotes.splice(index, 1); // Remove the used footnote from entry-specific list
          }
        }
      }
    }

    // Write the output JSON file
    fs.writeFile("output.json", JSON.stringify(jsonData, null, 2), (err) => {
      if (err) {
        console.error(err);
        return;
      }
      console.log("Output JSON file has been created successfully.");
    });
  });
});

...

this is my addfootnotestothis.json data:

[
  [
    "٥٣ - عَنْ[6] أَبِي سَعِيدٍ الخُدْرِيِّ رَضِيَ اللَّهُ عَنْهُ، عَنْ رَسُولِ اللَّهِ[7] ﷺ قَالَ: «لَا صَلَاةَ بَعْدَ الصُّبْحِ حَتَّى تَرْتَفِعَ الشَّمْسُ[8]، وَلَا صَلَاةَ بَعْدَ العَصْرِ حَتَّى تَغِيبَ الشَّمْسُ»[9].\nوَفِي البَابِ: عَنْ عَلِيِّ بْنِ أَبِي طَالِبٍ[10]، وَعَبْدِ اللَّهِ بْنِ\nمَسْعُودٍ[1]، وَعَبْدِ اللَّهِ بْنِ عَمُرَ بْنِ الخَطَّابِ[2]، وَعَبْدِ اللَّهِ بْنِ عَمْرِو بْنِ العَاصِي[3]، وَأَبِي هُرَيْرَةَ[4]، وَسَمُرَةَ بْنِ جُنْدُبٍ[5]، وَسَلَمَةَ ابْنِ الأَكْوَعِ[6]، وَزَيْدِ بْنِ ثَابِتٍ[7]، وَمُعَاذِ ابْنِ عَفْرَاءَ[8]، وَكَعْبِ بْنِ[9] مُرَّةَ[10]، وَأَبِي أُمَامَةَ البَاهِلِيِّ[11]، وَعَمْرِو بْنِ عَبَسَةَ السُّلَمِيِّ[12]، وَعَائِشَةَ[13] رَضِيَ اللَّهُ عَنْهُم، وَالصُّنَابِحِيِّ[14] - وَلَمْ يَسْمَعْ مِنَ النَّبِيِّ ﷺ[15] -."
  ],
  [
    "٥٤ - عَنْ جَابِرِ بْنِ عَبْدِ اللَّهِ رَضِيَ اللَّهُ عَنْهُما: «أَنَّ عُمَرَ بْنَ الخَطَّابِ رَضِيَ اللَّهُ عَنْهُ جَاءَ يَوْمَ الخَنْدَقِ بَعْدَمَا غَرَبَتِ الشَّمْسُ، فَجَعَلَ يَسُبُّ كُفَّارَ قُرَيْشٍ، وَيَقُولُ[1]: يَا رَسُولَ اللَّهِ! مَا كِدْتُ أُصَلِّي العَصْرَ حَتَّى كَادَتِ الشَّمْسُ تَغْرُبُ، فَقَالَ النَّبِيُّ[2] ﷺ: وَاللَّهِ مَا صَلَّيْتُهَا! قَالَ: فَقُمْنَا إِلَى بُطْحَانَ[3]، فَتَوَضَّأَ لِلصَّلَاةِ وَتَوَضَّأْنَا لَهَا[4]، فَصَلَّى العَصْرَ بَعْدَمَا غَرَبَتِ[5] الشَّمْسُ، ثُمَّ صَلَّى[6] بَعْدَهَا المَغْرِبَ[7]»[8].\nبَابُ فَضْلِ صَلَاةِ[1] الجَمَاعَةِ وَوُجُوبِهَا"
  ],
  [
    "٥٥ - عَنْ عَبْدِ اللَّهِ بْنِ عُمَرَ رَضِيَ اللَّهُ عَنْهُما أَنَّ رَسُولَ اللَّهِ ﷺ قَالَ: «صَلَاةُ الجَمَاعَةِ أَفْضَلُ مِنْ صَلَاةِ الفَذِّ[2] بِسَبْعٍ وَعِشْرِينَ دَرَجَةً»[3]."
  ],
]


this is my footnotes.txt data:

[6] في ب: «وعن».
[7] في ح، ل: «النبي».
[8] في ح زيادة: «قيد رمح».
[9] البخاري (586) واللفظ له، ومسلم (827).
[10] أخرجه أحمد (610)، وأبو داود (1274)، والنسائي (573).
[1] أخرجه أبو يعلى (4977).
[2] في ب: «وعبد اللَّه بن عمر بن الخطاب وعبد اللَّه بن مسعود» بتقديم وتأخير.
وحديثه أخرجه البخاري (583)، ومسلم (828).
[3] في ب، ج، ز، ط، ك، ل: «العاص» من غير ياء.
وحديثه أخرجه أحمد (6681).
[4] أخرجه البخاري (588)، ومسلم (825).
[5] في ي: «جندَب» بفتح الدال، وفي أ، ح، ل: بفتح الدال وضمها، والمثبت من ج، د، و، ط، ك.
قال النَّووي رحمه الله في شرح مسلم (15/ 50): «وفيها ثلاثُ لغات: (جندب) بضمِّ الدال وفتحِها والجيم مضمومةٌ فيهما، والثالثة حكاه القاضي: بكسر الجيمِ وفتح الدال».
وحديثه أخرجه أحمد (20168)، وابن أبي شيبة (7325)، وابن خزيمة (1274).
[6] أخرجه أحمد (16535).
[7] أخرجه أحمد (21661).
[8] أخرجه أحمد (17926)، والنسائي (518).
[9] «ابْنِ» سقطت من ج.
[10] أخرجه أحمد (18059).
[11] أخرجه أحمد (22245)، وعبد الرزاق (3948).
[12] أخرجه مسلم (832).
[13] أخرجه مسلم (833).
[14] في ح: «والصنابحي» بفتح الصاد وضمها، والمثبت من أ، ج، و، ط، ي، ك.
قال النَّووي رحمه الله في شرح مسلم (1/ 228): «بضمِّ الصاد المهملةِ».
وحديثه أخرجه مالك (2/ 306)، وأحمد (19063)، والنسائي (559).
[15] قوله: «وَلَمْ يَسْمَعْ مِنَ النَّبِيِّ صلى الله عليه وسلم» ليست في ز.
قال التِّرمذي رحمه الله في العلل الكبير (ص 21): «سألت … البخاري فقال: … وهو أبو عبد اللَّه الصُّنابحي، واسمه: عبدُ الرحمن بن عُسيلة، ولم يسمعْ من النبيِّ صلى الله عليه وسلم».
وانظر: الاستيعاب لابن عبد البر (2/ 841)، والإصابة في تمييز الصحابة لابن حجر (5/ 81).
ومن قوله: «وَفِي البَابِ» إلى قوله: «وَلَمْ يَسْمَعْ مِنَ النَّبِيِّ صلى الله عليه وسلم» أخذه المُصنِّف رحمه الله من كلام التِّرمذي بتصرف. انظر: جامع الترمذي (1/ 343)، والنكت للزركشي (ص 147).
[1] في ب: «قال»، وفي ج، ز، ح، ط، ي، ك، ل: «وقال»، وفي د: «فقال».
[2] في أ: «رسول اللَّه».
[3] في د، ل: «بطحان» بفتح الباء وضمها، والمثبت من أ، ب، ج، و، ح، ط، ي، ك.
قال ياقوت الحموي رحمه الله في معجم البلدان (1/ 446): «(بُطْحان): بالضم ثمَّ السكون، كذا يقوله المحدِّثون أجمعون، وحَكى أهل اللغة: (بَطِحان): بفتح أوله وكسرِ ثانيهِ، وقرأتُ بخط أبي الطيب … (بَطْحان)؛ بفتح أوَّله وسكون ثانيه، وهو: وادٍ بالمدينة».
وانظر: المعالم الأثيرة في السنة والسيرة لمحمد شُرَّاب (ص 49).
[4] «لَهَا» ليست في أ، و.
[5] في ج: «غابت».
[6] في ج، ل: «وصلى».
[7] في ح: «المغرب بعدها» بتقديم وتأخير.
[8] البخاري (596) واللفظ له، ومسلم (631).
وهذا الحديث ورد في نسخة (و) في آخر الباب التالي، وهو: (باب فضل صلاة الجماعة ووجوبها)، وكتب بحذائه في الحاشية: «ثبت حديثُ جابر هذا في بعض النسخ آخر حديثٍ من باب المواقيت من كتاب الصَّلاة، وفي بعضها على نحْو ثبوته في هذه النسخةِ»، والترتيب المثبت من أ، ب، ج، د، ز، ح، ط، ي، ك، ل.
[1] «صَلَاةِ» ليست في أ، ب، ج، د، ز، ح، ط، ي، ك، ل.
[2] أي: المنفرد المصلي وحده. مشارق الأنوار (2/ 150).
[3] البخاري (645)، ومسلم (650) واللفظ له.

now i will tell you my issue,

part of the output i am getting from this code is:
  

  [
    "٥٤ - عَنْ جَابِرِ بْنِ عَبْدِ اللَّهِ رَضِيَ اللَّهُ عَنْهُما: «أَنَّ عُمَرَ بْنَ الخَطَّابِ رَضِيَ اللَّهُ عَنْهُ جَاءَ يَوْمَ الخَنْدَقِ بَعْدَمَا غَرَبَتِ الشَّمْسُ، فَجَعَلَ يَسُبُّ كُفَّارَ قُرَيْشٍ، وَيَقُولُ[1]: يَا رَسُولَ اللَّهِ! مَا كِدْتُ أُصَلِّي العَصْرَ حَتَّى كَادَتِ الشَّمْسُ تَغْرُبُ، فَقَالَ النَّبِيُّ[2] ﷺ: وَاللَّهِ مَا صَلَّيْتُهَا! قَالَ: فَقُمْنَا إِلَى بُطْحَانَ[3]، فَتَوَضَّأَ لِلصَّلَاةِ وَتَوَضَّأْنَا لَهَا[4]، فَصَلَّى العَصْرَ بَعْدَمَا غَرَبَتِ[5] الشَّمْسُ، ثُمَّ صَلَّى[6] بَعْدَهَا المَغْرِبَ[7]»[8].\nبَابُ فَضْلِ صَلَاةِ[1] الجَمَاعَةِ وَوُجُوبِهَا",
    "[1] في ب: «قال»، وفي ج، ز، ح، ط، ي، ك، ل: «وقال»، وفي د: «فقال».\n[2] أي: المنفرد المصلي وحده. مشارق الأنوار (2/ 150).\n[3] في د، ل: «بطحان» بفتح الباء وضمها، والمثبت من أ، ب، ج، و، ح، ط، ي، ك.\nقال ياقوت الحموي رحمه الله في معجم البلدان (1/ 446): «(بُطْحان): بالضم ثمَّ السكون، كذا يقوله المحدِّثون أجمعون، وحَكى أهل اللغة: (بَطِحان): بفتح أوله وكسرِ ثانيهِ، وقرأتُ بخط أبي الطيب … (بَطْحان)؛ بفتح أوَّله وسكون ثانيه، وهو: وادٍ بالمدينة».\nوانظر: المعالم الأثيرة في السنة والسيرة لمحمد شُرَّاب (ص 49).\n[4] «لَهَا» ليست في أ، و.\n[5] في ج: «غابت».\n[6] في ج، ل: «وصلى».\n[7] في ح: «المغرب بعدها» بتقديم وتأخير.\n[8] البخاري (596) واللفظ له، ومسلم (631).\nوهذا الحديث ورد في نسخة (و) في آخر الباب التالي، وهو: (باب فضل صلاة الجماعة ووجوبها)، وكتب بحذائه في الحاشية: «ثبت حديثُ جابر هذا في بعض النسخ آخر حديثٍ من باب المواقيت من كتاب الصَّلاة، وفي بعضها على نحْو ثبوته في هذه النسخةِ»، والترتيب المثبت من أ، ب، ج، د، ز، ح، ط، ي، ك، ل.\n[1] «صَلَاةِ» ليست في أ، ب، ج، د، ز، ح، ط، ي، ك، ل."
  ]

while the expected correct output should have been like this:


  [
    "٥٤ - عَنْ جَابِرِ بْنِ عَبْدِ اللَّهِ رَضِيَ اللَّهُ عَنْهُما: «أَنَّ عُمَرَ بْنَ الخَطَّابِ رَضِيَ اللَّهُ عَنْهُ جَاءَ يَوْمَ الخَنْدَقِ بَعْدَمَا غَرَبَتِ الشَّمْسُ، فَجَعَلَ يَسُبُّ كُفَّارَ قُرَيْشٍ، وَيَقُولُ[1]: يَا رَسُولَ اللَّهِ! مَا كِدْتُ أُصَلِّي العَصْرَ حَتَّى كَادَتِ الشَّمْسُ تَغْرُبُ، فَقَالَ النَّبِيُّ[2] ﷺ: وَاللَّهِ مَا صَلَّيْتُهَا! قَالَ: فَقُمْنَا إِلَى بُطْحَانَ[3]، فَتَوَضَّأَ لِلصَّلَاةِ وَتَوَضَّأْنَا لَهَا[4]، فَصَلَّى العَصْرَ بَعْدَمَا غَرَبَتِ[5] الشَّمْسُ، ثُمَّ صَلَّى[6] بَعْدَهَا المَغْرِبَ[7]»[8].\nبَابُ فَضْلِ صَلَاةِ[1] الجَمَاعَةِ وَوُجُوبِهَا",
    "[1] في ب: «قال»، وفي ج، ز، ح، ط، ي، ك، ل: «وقال»، وفي د: «فقال».\n[2] في أ: «رسول اللَّه».\n[3] في د، ل: «بطحان» بفتح الباء وضمها، والمثبت من أ، ب، ج، و، ح، ط، ي، ك.\nقال ياقوت الحموي رحمه الله في معجم البلدان (1/ 446): «(بُطْحان): بالضم ثمَّ السكون، كذا يقوله المحدِّثون أجمعون، وحَكى أهل اللغة: (بَطِحان): بفتح أوله وكسرِ ثانيهِ، وقرأتُ بخط أبي الطيب … (بَطْحان)؛ بفتح أوَّله وسكون ثانيه، وهو: وادٍ بالمدينة».\nوانظر: المعالم الأثيرة في السنة والسيرة لمحمد شُرَّاب (ص 49).\n[4] «لَهَا» ليست في أ، و.\n[5] في ج: «غابت».\n[6] في ج، ل: «وصلى».\n[7] في ح: «المغرب بعدها» بتقديم وتأخير.\n[8] البخاري (596) واللفظ له، ومسلم (631).\nوهذا الحديث ورد في نسخة (و) في آخر الباب التالي، وهو: (باب فضل صلاة الجماعة ووجوبها)، وكتب بحذائه في الحاشية: «ثبت حديثُ جابر هذا في بعض النسخ آخر حديثٍ من باب المواقيت من كتاب الصَّلاة، وفي بعضها على نحْو ثبوته في هذه النسخةِ»، والترتيب المثبت من أ، ب، ج، د، ز، ح، ط، ي، ك، ل.\n[1] «صَلَاةِ» ليست في أ، ب، ج، د، ز، ح، ط، ي، ك، ل."
  ],

why is
[2] أي: المنفرد المصلي وحده. مشارق الأنوار (2/ 150).

coming where there should be
[2] في أ: «رسول اللَّه».

i think that, because
[2] في أ: «رسول اللَّه».

occurs more than once in the footnotes.txt, it is getting removed in the output file

*/
//
